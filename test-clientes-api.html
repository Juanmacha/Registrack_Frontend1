<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API de Clientes - Registrack</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .loading {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test API de Clientes - Registrack</h1>
        <p>Esta p√°gina permite probar la conexi√≥n con la API de clientes y verificar que los datos se est√©n transformando correctamente.</p>
        
        <div class="test-section">
            <h3>üîê Configuraci√≥n de Autenticaci√≥n</h3>
            <p>Primero necesitas hacer login para obtener un token v√°lido:</p>
            <input type="text" id="email" placeholder="Email" value="admin@registrack.com" style="padding: 8px; margin: 5px; width: 200px;">
            <input type="password" id="password" placeholder="Password" value="Admin123!" style="padding: 8px; margin: 5px; width: 200px;">
            <button onclick="login()">Login</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìã Obtener Todos los Clientes</h3>
            <p>Prueba el endpoint GET /api/gestion-clientes (ahora muestra TODOS los clientes)</p>
            <button onclick="testGetAllClientes()" id="btnGetAll">Obtener Clientes</button>
            <div id="getAllResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîç Obtener Cliente por ID</h3>
            <p>Prueba el endpoint GET /api/gestion-clientes/:id</p>
            <input type="number" id="clienteId" placeholder="ID del cliente" value="1" style="padding: 8px; margin: 5px; width: 100px;">
            <button onclick="testGetClienteById()" id="btnGetById">Obtener por ID</button>
            <div id="getByIdResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä Descargar Reporte Excel</h3>
            <p>Prueba el endpoint GET /api/gestion-clientes/reporte/excel</p>
            <button onclick="testDownloadExcel()" id="btnExcel">Descargar Excel</button>
            <div id="excelResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìà Estado de la Conexi√≥n</h3>
            <div id="connectionStatus">
                <span class="status error">Desconectado</span>
            </div>
            <div id="apiInfo" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de la API
        const API_BASE_URL = 'https://api-registrack-2.onrender.com';
        let authToken = null;

        // Funci√≥n para mostrar resultados
        function showResult(elementId, content, type = 'success') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }

        // Funci√≥n para mostrar estado de carga
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result loading';
            element.textContent = 'Cargando...';
        }

        // Funci√≥n para actualizar estado de conexi√≥n
        function updateConnectionStatus(status, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            const statusClass = status === 'connected' ? 'success' : status === 'loading' ? 'loading' : 'error';
            statusElement.innerHTML = `<span class="status ${statusClass}">${message || (status === 'connected' ? 'Conectado' : status === 'loading' ? 'Conectando...' : 'Desconectado')}</span>`;
        }

        // Funci√≥n de login
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showResult('loginResult', 'Por favor ingresa email y contrase√±a', 'error');
                return;
            }

            showLoading('loginResult');
            updateConnectionStatus('loading', 'Conectando...');

            try {
                const response = await fetch(`${API_BASE_URL}/api/usuarios/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correo: email, contrasena: password })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    authToken = data.token;
                    localStorage.setItem('token', authToken);
                    showResult('loginResult', `‚úÖ Login exitoso!\nToken: ${authToken.substring(0, 50)}...\nUsuario: ${data.usuario?.nombre} ${data.usuario?.apellido}`, 'success');
                    updateConnectionStatus('connected', 'Conectado');
                    
                    // Mostrar informaci√≥n de la API
                    document.getElementById('apiInfo').style.display = 'block';
                    document.getElementById('apiInfo').textContent = `API Base URL: ${API_BASE_URL}\nToken v√°lido: S√≠\nUsuario: ${data.usuario?.nombre} ${data.usuario?.apellido}\nRol: ${data.usuario?.rol}`;
                } else {
                    showResult('loginResult', `‚ùå Error en login: ${data.message || data.error || 'Error desconocido'}`, 'error');
                    updateConnectionStatus('error', 'Error de autenticaci√≥n');
                }
            } catch (error) {
                showResult('loginResult', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                updateConnectionStatus('error', 'Error de conexi√≥n');
            }
        }

        // Funci√≥n para probar obtener todos los clientes
        async function testGetAllClientes() {
            if (!authToken) {
                showResult('getAllResult', '‚ùå Primero debes hacer login', 'error');
                return;
            }

            showLoading('getAllResult');
            document.getElementById('btnGetAll').disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/gestion-clientes`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const clientes = data.data?.clientes || data.clientes || data;
                    const total = data.data?.total || clientes.length;
                    
                    let result = `‚úÖ Clientes obtenidos exitosamente!\n\n`;
                    result += `Total de clientes: ${total}\n`;
                    result += `Estructura de respuesta: ${JSON.stringify(data, null, 2)}\n\n`;
                    
                    if (Array.isArray(clientes) && clientes.length > 0) {
                        result += `Primer cliente:\n`;
                        result += `- ID: ${clientes[0].id_cliente}\n`;
                        result += `- Nombre: ${clientes[0].usuario?.nombre || 'N/A'} ${clientes[0].usuario?.apellido || 'N/A'}\n`;
                        result += `- Email: ${clientes[0].usuario?.correo || 'N/A'}\n`;
                        result += `- Marca: ${clientes[0].marca || 'N/A'}\n`;
                        result += `- Origen: ${clientes[0].origen || 'N/A'} (${clientes[0].origen === 'solicitud' ? 'Creado por solicitud' : clientes[0].origen === 'directo' ? 'Creado por admin' : 'Importado'})\n`;
                        result += `- Estado: ${clientes[0].estado ? 'Activo' : 'Inactivo'}\n`;
                        
                        if (clientes[0].empresas && clientes[0].empresas.length > 0) {
                            result += `- Empresa: ${clientes[0].empresas[0].nombre || 'N/A'}\n`;
                            result += `- NIT: ${clientes[0].empresas[0].nit || 'N/A'}\n`;
                        }
                        
                        // Mostrar distribuci√≥n por origen
                        const origenCount = clientes.reduce((acc, cliente) => {
                            const origen = cliente.origen || 'desconocido';
                            acc[origen] = (acc[origen] || 0) + 1;
                            return acc;
                        }, {});
                        
                        result += `\nDistribuci√≥n por origen:\n`;
                        Object.entries(origenCount).forEach(([origen, count]) => {
                            result += `- ${origen}: ${count} cliente(s)\n`;
                        });
                    } else {
                        result += `No se encontraron clientes.`;
                    }

                    showResult('getAllResult', result, 'success');
                } else {
                    showResult('getAllResult', `‚ùå Error: ${data.message || data.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showResult('getAllResult', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            } finally {
                document.getElementById('btnGetAll').disabled = false;
            }
        }

        // Funci√≥n para probar obtener cliente por ID
        async function testGetClienteById() {
            if (!authToken) {
                showResult('getByIdResult', '‚ùå Primero debes hacer login', 'error');
                return;
            }

            const clienteId = document.getElementById('clienteId').value;
            if (!clienteId) {
                showResult('getByIdResult', '‚ùå Por favor ingresa un ID de cliente', 'error');
                return;
            }

            showLoading('getByIdResult');
            document.getElementById('btnGetById').disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/gestion-clientes/${clienteId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    let result = `‚úÖ Cliente obtenido exitosamente!\n\n`;
                    result += `Estructura de respuesta: ${JSON.stringify(data, null, 2)}`;
                    showResult('getByIdResult', result, 'success');
                } else {
                    showResult('getByIdResult', `‚ùå Error: ${data.message || data.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showResult('getByIdResult', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            } finally {
                document.getElementById('btnGetById').disabled = false;
            }
        }

        // Funci√≥n para probar descarga de Excel
        async function testDownloadExcel() {
            if (!authToken) {
                showResult('excelResult', '‚ùå Primero debes hacer login', 'error');
                return;
            }

            showLoading('excelResult');
            document.getElementById('btnExcel').disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/gestion-clientes/reporte/excel`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    // Crear blob y descargar archivo
                    const blob = await response.blob();
                    const urlBlob = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = urlBlob;
                    link.download = 'reporte_clientes.xlsx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(urlBlob);
                    
                    showResult('excelResult', '‚úÖ Reporte Excel descargado exitosamente!', 'success');
                } else {
                    const data = await response.json();
                    showResult('excelResult', `‚ùå Error: ${data.message || data.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showResult('excelResult', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            } finally {
                document.getElementById('btnExcel').disabled = false;
            }
        }

        // Verificar si hay token guardado al cargar la p√°gina
        window.onload = function() {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                authToken = savedToken;
                updateConnectionStatus('connected', 'Conectado (token guardado)');
                document.getElementById('apiInfo').style.display = 'block';
                document.getElementById('apiInfo').textContent = `API Base URL: ${API_BASE_URL}\nToken v√°lido: S√≠ (guardado)\nToken: ${savedToken.substring(0, 50)}...`;
            }
        };
    </script>
</body>
</html>

